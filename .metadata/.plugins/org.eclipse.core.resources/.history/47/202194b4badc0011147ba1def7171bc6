package de.test.respWriter;

import java.io.IOException;
import java.io.Writer;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.apache.lucene.document.Document;
import org.apache.solr.common.SolrDocument;
import org.apache.solr.common.SolrDocumentList;
import org.apache.solr.common.params.CommonParams;
import org.apache.solr.common.params.SolrParams;
import org.apache.solr.common.util.NamedList;
import org.apache.solr.request.SolrQueryRequest;
import org.apache.solr.response.QueryResponseWriter;
import org.apache.solr.response.SolrQueryResponse;
import org.apache.solr.response.TextResponseWriter;
import org.apache.solr.search.DocIterator;
import org.apache.solr.search.DocList;
import org.apache.solr.search.DocSlice;
import org.apache.solr.search.SolrIndexReader;

import com.hp.hpl.jena.rdf.model.Model;
import com.hp.hpl.jena.tdb.TDBFactory;

public class CustomResponseWriter implements QueryResponseWriter {

	@Override
	public void write(Writer writer, SolrQueryRequest request,
			SolrQueryResponse response) throws IOException {
		Model model = TDBFactory.createDataset("/home/stefan/stores/ts/").getDefaultModel();
		
		SolrParams p = request.getParams();
		System.out.println(p.get("sparql"));
		
		String tsId= (String)response.getValues().get("tsId");
		response.getValues().getName(0);
		System.out.println(response.getValues().getName(0));
		System.out.println(response.getValues().getName(1));
		List<Object> list = response.getValues().getAll("response");
		DocSlice d = (DocSlice)list.get(0);
		System.out.println(d.size());
		
		NamedList lst = response.getValues();
	    Boolean omitHeader = request.getParams().getBool(CommonParams.OMIT_HEADER);
	    if(omitHeader != null && omitHeader) lst.remove("responseHeader");
	    int sz = lst.size();
	    int start=0;
	    
	    SolrIndexReader reader = request.getSearcher().getReader();
	    
	    for (int i=start; i<sz; i++) {
	    	System.out.println(lst.getName(i));
	    	
	    	if(lst.getVal(i) instanceof DocSlice){
	    		DocSlice slice = (DocSlice)lst.getVal(i);
	    		System.out.println(slice.exists(0));
	    		
	    		SolrDocumentList rl = new SolrDocumentList();
	    	      for (DocIterator it = slice.iterator(); it.hasNext(); ){
	    	    	  Document doc = reader.document(it.nextDoc());
	    	    	  System.out.println(doc.getValues("tsId")[0]);
	    	      }
	    		
	    		
	    		
	    		
	    	}
	      }
	    
	    /*  {
        int docId = it.nextDoc();
        Document doc = reader.document(docId);
        SolrDocument sdoc = new SolrDocument();
        List<Fieldable> fields = doc.getFields();
        for (Fieldable field : fields) {
          String fn = field.name();
          if (returnFields.contains(fn)) {
            sdoc.addField(fn, doc.get(fn));
          }
        }
        if (returnFields.contains("score")) {
          sdoc.addField("score", it.score());
        }
        if (returnFields.contains("rank")) {
          List<Integer> thumbs = RankUpdateListener.getThumbs(docId);
          sdoc.addField("thumbs_up", thumbs.get(0));
          sdoc.addField("thumbs_down", thumbs.get(1));
          sdoc.addField("rank", RankUpdateListener.getRank(docId));
        }
        rl.add(sdoc);
      }
      rl.setMaxScore(slice.maxScore());
      rl.setNumFound(slice.matches());
      rb.rsp.getValues().remove("response");
      rb.rsp.add("response", rl);
    }
  }*/
	    
	    
	    
		
		
		
		/*for(String s:response.getReturnFields()){
			System.out.println(s);
		}
		System.out.println(tsId);*/
		
		//String sparqlQuery = p.get("sparql");
		//sparqlQuery.replaceAll("tsId", tsId);
		//System.out.println(sparqlQuery);
		
//		String queryString = " Select ?y ?z where { <http://de.test/a> ?y ?z } " ;
		//  Query query = QueryFactory.create(sparqlQuery) ;
		//  QueryExecution qexec = QueryExecutionFactory.create(query, model) ;
		
	//	  try {
	//	    ResultSet results = qexec.execSelect() ;
		    
		    //String str =ResultSetFormatter.asText(results);
		//    ResultSetFormatter.outputAsJSON(System.out, results);
		    //writer.write(str);
//		    JSONOutputResultSet set = new JSONOutputResultSet(System.out);
		    /*for ( ; results.hasNext() ; )
		    {
		      QuerySolution soln = results.nextSolution() ;
		      RDFNode x = soln.get("varName") ;       // Get a result variable by name.
		      Resource r = soln.getResource("VarR") ; // Get a result variable - must be a resource
		      Literal l = soln.getLiteral("VarL") ;   // Get a result variable - must be a literal
		    }*/
	//	  } finally { qexec.close() ; }
		
		

	}

	@Override
	public String getContentType(SolrQueryRequest request,
			SolrQueryResponse response) {
		// TODO Auto-generated method stub
		return CONTENT_TYPE_TEXT_UTF8;
	}

	@Override
	public void init(NamedList args) {
		// TODO Auto-generated method stub

	}

}


class OwnWriter extends TextResponseWriter{

	public OwnWriter(Writer writer, SolrQueryRequest req, SolrQueryResponse rsp) {
		super(writer, req, rsp);
		
	}
	
	public void writeResponse(){
		
	}

	@Override
	public void writeNamedList(String name, NamedList val) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeDoc(String name, Document doc, Set<String> returnFields,
			float score, boolean includeScore) throws IOException {
		System.out.println("WriteDoc: " + returnFields + " - " + name);
		
	}

	@Override
	public void writeSolrDocument(String name, SolrDocument doc,
			Set<String> returnFields, Map pseudoFields) throws IOException {
		System.out.println("SolrDoc: " + returnFields + " - " +name);
		
	}

	@Override
	public void writeDocList(String name, DocList ids, Set<String> fields,
			Map otherFields) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeSolrDocumentList(String name, SolrDocumentList docs,
			Set<String> fields, Map otherFields) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeStr(String name, String val, boolean needsEscaping)
			throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeMap(String name, Map val, boolean excludeOuter,
			boolean isFirstVal) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeArray(String name, Object[] val) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeArray(String name, Iterator val) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeNull(String name) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeInt(String name, String val) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeLong(String name, String val) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeBool(String name, String val) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeFloat(String name, String val) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeDouble(String name, String val) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeDate(String name, String val) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeShort(String name, String val) throws IOException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void writeByte(String name, String s) throws IOException {
		// TODO Auto-generated method stub
		
	}
	
}